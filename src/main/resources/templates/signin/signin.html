<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{main/base}">
	  
<head>
	<title>로그인</title>
	<link rel="stylesheet" th:href="@{/css/signin.css}" />
 </head>

<div layout:fragment="content">
<div class ="container">

	<div class ="loginform">
	    <h2 class = "title">로그인</h2>
		<div id="loginForm">
			<div class = "emailDiv">
		        <label for="email">이메일</label>
		        <input type="email" id=email name="email" required autofocus placeholder="example@example.com">
		        <div id = "emailInitButton">&times;</div>
			</div>
			<div class = "passwordDiv">
		        <label for="password">비밀번호</label>
		        <input type="password" id="password" name="password" required placeholder="password">
		        <div id = "passwordViewButton"></div>
		        <div id = "passwordInitButton">&times;</div>
			</div>
	        <div id ="etcActionDiv">
	        	<input type="checkbox" id="rememberEmailCheckbox" name="rememberEmailCheckbox">
	        	<label for="rememberEmailCheckbox">이메일 저장</label>
				<a id="findEmail" href="/find/email">이메일 찾기</a>
				<a id="findPassword" href="/find/password">비밀번호 찾기</a>
	        </div>
	        <button id = "signInButton" type="button">로그인</button>
	    </div>
	        <button id="joinButton" type="button">회원가입</button>
	    <div id = "underline-text"></div>
	    <div id = "OAutoLoginBlcok">
	        <a onclick="loginWithKakao()" id="kakao-login">
	        	<img src="https://chamman.s3.ap-northeast-2.amazonaws.com/static/img/kakaoLogin.png" alt="Kakao Login Logo">
		    </a>
			 <a onclick="loginWithNaver()" id="naver-login">
		        <img src="https://chamman.s3.ap-northeast-2.amazonaws.com/static/img/naverLogin.png" alt="Naver Login Logo">
		    </a>

    </div>
    </div>
    
</div>
<script th:src="@{/js/rememberEmail.js}"></script>
<script th:inline="javascript">
    const encodedRedirect = /*[[${redirect}]]*/ null;
</script>

<script>
	var email = document.getElementById('email');
	var emailInitButton = document.getElementById('emailInitButton');
	email.addEventListener('input', function() {
	    buttonDisplay(email, emailInitButton);
	});
	email.addEventListener('blur', function() {
	    buttonDisplay(email, emailInitButton);
	});
	emailInitButton.addEventListener('click', function() {
	    init(email,emailInitButton);
	});

	var password = document.getElementById('password');
	var passwordInitButton = document.getElementById('passwordInitButton');
	var passwordViewButton = document.getElementById('passwordViewButton');
	password.addEventListener('input', function() {
	    buttonDisplay(password, passwordInitButton);
	    buttonDisplay(password, passwordViewButton);
	});
	password.addEventListener('blur', function() {
	    buttonDisplay(password, passwordInitButton);
	    buttonDisplay(password, passwordViewButton);
	});
	passwordInitButton.addEventListener('click', function() {
	    init(password,passwordInitButton);
	    init(password,passwordViewButton);
	});
	passwordViewButton.addEventListener('click', function() {
	    view(password,passwordViewButton);
	});

	function view(input,button){
	    if (input.type === 'password') {
	    	input.type = 'text';
	    	button.style.backgroundImage= "url('https://chamman.s3.ap-northeast-2.amazonaws.com/static/img/eyeIcon.png')";
		} else {
	    	input.type = 'password';
	    	button.style.backgroundImage= "url('https://chamman.s3.ap-northeast-2.amazonaws.com/static/img/eyeHiddenIcon.png')";
	    }
	}
	function init(input,button){
		input.value='';
		button.style.display="none";
	}

	function buttonDisplay(input,button){
		if(input.value){
			button.style.display="inline";
		}else{
			button.style.display="none";
		}
	}
	function openFindWindow(url) {
	    // 새 창의 크기 지정
	    const width = 500;
	    const height = 800;

	    // 창의 중앙 위치 계산
	    const left = window.screenX + (window.outerWidth / 2) - (width / 2);
	    const top = window.screenY + (window.outerHeight / 2) - (height / 2);

	    // 새로운 창 열기
	    window.open(
	        url,  // 열고자 하는 URL
	        '_blank',  // 새 창의 이름 또는 _blank (새 탭)
	        'width=' + width + ',height=' + height + ',top=' + top + ',left=' + left  // 창의 크기와 위치
	    );
	    return false; // 기본 링크 동작을 막기 위해 false를 반환
	}

	document.getElementById('joinButton').addEventListener('click',function(){
		window.location.href="/signup1";
	});

	  function loginWithKakao() {
	    let kakaoAuthUrl = `/oauth2/authorization/kakao`;
		if (encodedRedirect) {
			kakaoAuthUrl += '?redirect='+encodedRedirect;
		}
	    window.location.href = kakaoAuthUrl;
	  }

	  function loginWithNaver() {

	    let naverAuthUrl = `/oauth2/authorization/naver`;
		if (encodedRedirect) {
			naverAuthUrl += '?redirect='+encodedRedirect;
		}
	    window.location.href = naverAuthUrl;
	  }
	  </script>

<script type="module">
	import { signIn } from '/js/sign.js';

	document.getElementById("signInButton").addEventListener("click", (e)=> {
		var email = document.getElementById("email").value;
		var password = document.getElementById("password").value;
		var rememberEmail = document.getElementById("rememberEmailCheckbox").checked;

		signIn(email,password,rememberEmail,encodedRedirect,
		(json)=>{
			window.location.href = json.data.redirect;
		},
		(error)=>{
			if (error.type === "VALIDATION") {
			    	alert(error.message);
			  	} else if (error.type === "SERVER") {
					if(error.status === 401 || error.status === 404){
			    	alert("이메일과 비밀번호를 확인해 주세요.");
					}  else if(error.status === 500){
			    	alert("죄송합니다. 현재 접속이 불가능 합니다.");
					}else{
			    	alert("죄송합니다. 현재 접속이 불가능 합니다.");
					}
			}
		});
	});
</script>
</div>
</html>

